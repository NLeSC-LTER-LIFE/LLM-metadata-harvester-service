FROM python:3.12-slim

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    HOME=/tmp

WORKDIR /app

RUN apt-get update && apt-get install -y \
    gcc \
    curl \
    git \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# ---- llm-metadata-harvester (editable) ----
WORKDIR /opt
RUN git clone https://github.com/LTER-LIFE/llm-metadata-harvester.git \
    && pip install -e /opt/llm-metadata-harvester

# ---- dev tooling ----
RUN pip install watchfiles

# ---- playwright ----
RUN playwright install-deps \
    && playwright install chromium chromium-headless-shell

# ---- ONLY copy pyproject for dependency resolution ----
WORKDIR /app
COPY pyproject.toml .
COPY README.md .

# Install *dependencies only*, not the project itself
# For dev only: create an empty src/ so pip can resolve extras
RUN mkdir -p src && touch src/__init__.py
ARG EXTRAS=api,dev,runtime
RUN pip install ".[${EXTRAS}]"

ENV PYTHONPATH=/app/src
