Bootstrap: docker
From: python:3.12-slim

%labels
    Author MeiertGrootes
    Project LLM-metadata-harvester-service

%environment
    export PYTHONUNBUFFERED=1
    export PLAYWRIGHT_BROWSERS_PATH=/opt/playwright-browsers
    export HOME=/tmp

%post
    set -e

    # Ensure predictable HOME during build
    export HOME=/tmp
    export PLAYWRIGHT_BROWSERS_PATH=/opt/playwright-browsers

    apt-get update && apt-get install -y \
        git \
        ca-certificates \
        fonts-liberation \
        && rm -rf /var/lib/apt/lists/*

    mkdir -p /opt /tmp /opt/playwright-browsers

    # Install Python dependencies
    git clone https://github.com/LTER-LIFE/llm-metadata-harvester.git
    cd llm-metadata-harvester
    pip install --no-cache-dir .
    cd ..

    #pip install --no-cache-dir "llm-metadata-harvester[scrape]"

    # Install Playwright system deps + browsers
    playwright install-deps
    playwright install chromium chromium-headless-shell

    # Make everything readable by non-root users
    chmod -R a+rX /opt /usr/local

%files
    entrypoint.py /opt/entrypoint.py


%runscript
    # Load bundled args if provided
    if [ -n "${ENTRYPOINT_ARGS}" ]; then
        exec python /opt/entrypoint.py "$ENTRYPOINT_ARGS" "$@"
    else
        exec python /opt/entrypoint.py "$@"
    fi




